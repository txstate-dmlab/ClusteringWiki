function editableClusterTree(){var f=this;this.treeDivElementId="clusterTree";this.treeMessageElementId="ectMessage";this.resultsDivElementId="response";this.resultsFooterDivElementId="responseFooter";this.statsDivElementId="stats";this.editLogElementId="clusterEditsMsg";this.timersElementId="clusterTimesMsg";this.animationSpeed="fast";this.debug=false;this.debugDivElementId=false;this.searchFunctionName="processQ";this.highlightFunction=false;this.maximumLabelLength=100;this.editAllowed=false;this.dragAllowed=false;this.taggingEnabled=false;this.taggingElementId="remainingTagCount";this.disabledMessage="Please log in to enable editing.";this.options={treeDivElementId:true,treeMessageElementId:true,resultsDivElementId:true,resultsFooterDivElementId:true,statsDivElementId:true,editLogElementId:true,timersElementId:true,animationSpeed:true,debug:true,debugDivElementId:true,searchFunctionName:true,highlightFunction:true,maximumLabelLength:true,editAllowed:true,dragAllowed:true,taggingEnabled:true,disabledMessage:true};for(n in arguments[0]){if(n in this.options&&this.options[n]){this[n]=arguments[0][n]}}this.contextMenuDiv='<div class="contextMenu" id="ecTreeMenu">	<span class="addNode"><img src="includes/images/tree/node_add.png" /> Create internal label </span>	<span class="addBottomNode"><img src="includes/images/tree/bottom_node_add.png" /> Create bottom label </span>	<span class="copyNode"><img src="includes/images/tree/node_copy.png" /> Copy label </span>	<span class="copyResult"><img src="includes/images/tree/page_copy.png" /> Copy result </span>	<span class="cutNode"><img src="includes/images/tree/node_cut.png" /> Cut label </span>	<span class="cutResult"><img src="includes/images/tree/page_cut.png" /> Cut result </span>	<span class="pasteNode"><img src="includes/images/tree/node_paste.png" /> Paste label </span>	<span class="pasteResult"><img src="includes/images/tree/page_paste.png" /> Paste result </span>	<span class="rename"><img src="includes/images/tree/node_rename.png" /> Rename label </span>	<span class="deleteNode"><img src="includes/images/tree/node_delete.png" /> Delete label </span>	<span class="deleteResult"><img src="includes/images/tree/page_delete.png" /> Delete result </span>	<span class="clearAllEdits"><img src="includes/images/tree/tree_clear_all_edits.png"/> Clear all edits </span>	<span class="showWithoutEdits"><img src="includes/images/tree/tree_without_edits.png"/> Show tree w/o edits </span></div>';this.disabledEditContextMenuDiv='<div class="contextMenu" id="ectMenuEditDisabled"> '+this.disabledMessage+" </span></div>";this.browseTInitContextMenuDiv='<div class="contextMenu" id="ectMenuBrowseTInit">   <span class="enableEditing"> Editing disabled while viewing tree w/o edits. </span></div>';this.emptyClusterWarning='<span id="ectEmptyClusterWarning" class="error">This cluster is empty and will not be shown in a re-built tree unless one or more result nodes are added to it before re-isuing the query.</span>';this.timer=function(){this.currentTime=0;this.time=0;this.startTimer=function(){d=new Date();this.currentTime=d.getTime()};this.stopTimer=function(){d=new Date();this.time=d.getTime()-this.currentTime;this.time=Math.round(this.time/10)/100;return this.getTime()};this.addTime=function(l){var h=l.split(" ");if(h.length<2){this.time+=parseFloat(l);return}if(h[1]=="s"){this.time+=parseFloat(l)}else{if(h[1]=="ms"){this.time+=(parseFloat(l)/1000)}}};this.subtractTime=function(l){var h=l.split(" ");if(h.length<2){this.time-=parseFloat(l);return}if(h[1]=="s"){this.time-=parseFloat(l)}else{if(h[1]=="ms"){this.time-=(parseFloat(l)/1000)}}};this.getTime=function(){return Math.round(this.time*1000)/1000+" s"}};this.execTimer=new this.timer();this.presentationTimer=new this.timer();this.root=null;var b=null;var e=null;var a=$("#"+this.resultsDivElementId);this.results=null;this.customResultLabels={};this.maxPathFieldSize=300;this.pagesIndex={};this.maximumDepth=4;this.nextClusterId=1;this.displayedPagesNodePath="";this.mousePressed=false;this.dragSource=null;this.dragDestination=null;this.dragCloneItem=null;this.dragSetting=false;this.dragCounter=0;this.activeNode=null;this.activeNodeOp="copy";this.activePage=null;this.activePageNodePath="";this.activePageOp="copy";this.activeLabelPaths=[];this.activeRenameLabel=null;this.activeQueryParams={};this.tagItems={};this.tagCount=0;this.tagSelectPaths=[];this.tagVisitOnlyPathsRate=0.5;this.tagExecutionInfo={};this.executionTimes=null;this.labelPath=function(l,h){this.cardinality=0;this.lPath=[];this.toString=function(){return this.cardinality>0?"+ "+this.lPath.join(" >> "):"- "+this.lPath.join(" >> ")};if(typeof l.length==="number"){this.lPath=l.slice(0)}if(typeof h=="undefined"||h>0){this.cardinality=1}else{this.cardinality=-1}};this.jsonLabelPathSet=function(){return $.toJSON(this.activeLabelPaths)};this.clearLabelPathChanges=function(){this.activeLabelPaths=[];if(this.editLogElementId&&$("#"+this.editLogElementId).length!=0){$("#"+this.editLogElementId).text("")}};this.showLabelPathChanges=function(){if(this.editLogElementId&&$("#"+this.editLogElementId).length!=0){if($("#"+this.editLogElementId).is(":visible")){$("#"+this.editLogElementId).text(this.activeLabelPaths.join("\n"))}}else{this.debugMessage(this.activeLabelPaths.join("\n"))}};this.clearTimerMessages=function(){this.activeLabelPaths=[];if(this.timersElementId&&$("#"+this.timersElementId).length!=0){$("#"+this.timersElementId).text("")}this.execTimer.startTimer()};this.showTimerMessages=function(o){if(typeof o=="undefined"){o={}}o.totalResponseTime=this.execTimer.stopTimer();o.presentation=this.presentationTimer.stopTimer();var l=new this.timer();var h=new this.timer();h.addTime(o.totalResponseTime);if("search" in o){var m="Retrieving results: "+o.search+"\n";h.subtractTime(o.search)}if("preprocessing" in o){m+="Preprocessing: "+o.preprocessing+"\n";l.addTime(o.preprocessing)}if("clustering" in o){m+="Initial clustering: "+o.clustering+"\n";l.addTime(o.clustering)}if("preferences" in o){m+="Applying preferences: "+o.preferences+"\n";l.addTime(o.preferences)}m+="Presenting final tree: "+o.presentation+"\n";l.addTime(o.presentation);h.subtractTime(l.getTime());m+="Other: "+h.getTime()+"\n";m+="Total execution time: "+l.getTime()+"\n";m+="Total response time: "+o.totalResponseTime+"\n\n";o.totalExecutionTime=l.getTime();o.other=h.getTime();this.executionTimes=this.clone(o);if(this.timersElementId&&$("#"+this.timersElementId).length!=0){$("#"+this.timersElementId).text(m)}};this.getExecutionTimes=function(){return this.executionTimes!=null?this.executionTimes:{}};this.getInternalStructure=function(){return this.root!=null?this.root.toJSON():"{}"};this.changePathInPathSet=function(l,q,m){var h=typeof q=="object"?q.length:q;l=l.slice(0);for(i=0;i<l.length;i++){var o=l[i];for(j=0;j<h-1;j++){o.shift()}for(k=m.length-1;k>-1;k--){o.unshift(m[k])}l[i]=o.slice(0);o=null}h=null;return l};this.logToConsole=function(h){if(window.console&&window.console.log){window.console.log(h)}};this.clone=function g(h){if(h==null||typeof(h)!="object"){return h}return jQuery.extend(true,{},h)};this.uniqueArrayPush=function(l,h){for(i in l){if(l[i]==h){return l}}l.push(h);return l};this.getArraySet=function(q,m,h){if(typeof q!="object"||typeof q.length!=="number"){return false}if(q.length<2){return q}if(typeof m!="undefined"&&!m){if(typeof h=="function"){q.sort(h)}else{q.sort()}}var l=new Array();var o=null;for(i in q){if(q[i]!=o){l.push(q[i])}o=q[i]}return l};this.setEditAllowed=function(h){this.editAllowed=h==true};this.setDisabledMessage=function(l){var h=this.disabledMessage;this.disabledMessage=l;this.disabledEditContextMenuDiv=this.disabledEditContextMenuDiv.replace(h,l);$("#ectMenuEditDisabled").html($("#ectMenuEditDisabled").html().replace(h,l));h=null};this.enableTagging=function(h){this.taggingEnabled=h==true};this.showStats=function(h){setDivMessage(this.statsDivElementId,h)};this.showResultsMessage=function(l,h){setDivMessage(this.resultsDivElementId,l,null,h)};this.showTreeMessage=function(l,h){setDivMessage(this.treeMessageElementId,l,5000,h);if(typeof h!="undefined"&&h=="error"){if($.scrollTo){$.scrollTo($("#"+f.treeMessageElementId),{offset:-250})}}};this.debugMessage=function(l){if(typeof l=="object"){if(l.length){l=l.join(", ")}else{var h="";for(i in l){h+="key: "+i+" .. value: "+l[i]+"\n"}l=h;h=null}}if(this.debug==true){if(this.debugDivElementId&&$("#"+this.debugDivElementId).length!=0){$("#"+this.debugDivElementId).text(l)}else{this.logToConsole(l+"\n")}}};this.node=function(l,h,m){this.id=-1;this.level=-1;this.pages=null;this.path=new Array();this.addedPath=false;this.addedPages=null;this.label="";this.parent=l;this.children=null;this.childrenIndex={};this.maxDepth=0;this.getId=function(){return this.id};this.setId=function(o){this.id=o};this.getLevel=function(){return this.level};this.setLevel=function(o){this.level=o};this.getPages=function(){return this.pages};this.getPath=function(){return this.path.slice(0)};this.setPath=function(o){this.path=o.slice(0)};this.getLabel=function(){return this.label};this.setLabel=function(o){this.label=o};this.getParent=function(){return this.parent};this.setParent=function(o){this.parent=o};this.getChildren=function(){return this.children};this.setChildren=function(o){if(o&&typeof o.length==="number"){this.children=o.slice(0)}};this.getMaxDepth=function(){return this.maxDepth};this.setMaxDepth=function(o){this.maxDepth=o};this.toJSON=function(){return $.toJSON(this.parentLess())};this.parentLess=function(){var q={id:this.id+"",level:this.level,pages:this.pages,path:this.path,label:this.label,maxDepth:0,children:null};if(this.children!=null){q.children=new Array();for(c in this.children){q.children[q.children.length]=this.children[c].parentLess()}}return q};this.clone=function(o,q){if(typeof q=="undefined"){q=false}if(typeof o=="undefined"){o=this.parent}return new f.node(o,this.parentLess(),q)};this.getParentId=function(){return this.parent!=null?this.parent.getId():""};this.getSize=function(){if(this.children!=null){var o=0;for(c in this.children){o+=this.children[c].getSize()}return o}else{return this.pages==null?0:this.pages.length}};this.getUniquePageCount=function(){var o=this.getChildPages();var r=-1;var q=0;for(i in o){if(o[i]!=r){q++}r=o[i]}o=null;r=null;return q};this.getPathString=function(){return this.path.join(".")};this.getDisplayLabel=function(){return this.getLabel()+"   ("+this.getUniquePageCount()+")"};this.getPathNode=function(o){if(typeof o=="string"){o=o.split(".")}if(typeof o.length!=="number"||o.length<1||o[0]!="0"){return null}var q=f.root;for(i=1;i<o.length;i++){q=q.getChild(o[i]);if(q==null){return q}}return q};this.getLabelPath=function(r,o){if(typeof r=="undefined"){r=this.path}if(typeof r=="string"){r=r.split(".")}if(typeof r.length!=="number"||r.length<1||r[0]!="0"){return[]}var s=f.root;var q=new Array();q[q.length]=s.getLabel();for(i=1;i<r.length;i++){s=s.getChild(r[i]);if(s!=null){q[q.length]=s.getLabel()}}if(typeof o!="undefined"&&s.hasPage(o)){q[q.length]=f.getResultNodeLabel(o)}s=null;return q};this.getChildIndexPath=function(u,q){if(typeof u=="undefined"){u=this.path}if(typeof u=="string"){u=u.split(".")}if(typeof u.length!=="number"||u.length<1||u[0]!="0"){return[]}var w=f.root;var t=new Array();t[t.length]=0;for(var s=1;s<u.length;s++){var v=w.getChildren();if(v==null){break}for(var r=0;r<v.length;r++){if(v[r].id==u[s]){t[t.length]=r+1;break}}w=w.getChild(u[s])}if(typeof q!="undefined"){if(u.length==1){t[t.length]=parseInt(q)+1}else{var o=w.getChildPages();o=f.getArraySet(o,true,function(y,x){return y-x});for(var r=0;r<o.length;r++){if(o[r]==q){t[t.length]=r+1}}}}w=null;return t};this.getLeafLabelPathSet=function(u,t){if(typeof u=="undefined"){u=new Array()}var s,r;if(typeof t=="undefined"){s=this.getLabelPath(this.path)}else{s=t.slice(0);s.push(this.getLabel())}if(this.children!=null){for(c in this.children){this.children[c].getLeafLabelPathSet(u,s.slice(0))}}else{if(this.pages!=null){r=f.results.results;for(i in this.pages){var q=s.slice(0);var o=f.getResultNodeLabel(this.pages[i]);q.push(o);u.push(q);q=null;o=null}}}s=null;pages=null;return u};this.getChild=function(o){if(this.children==null){return null}if("c"+o in this.childrenIndex){return this.children[this.childrenIndex["c"+o]]}return null};this.getChildPages=function(q){var o=new Array();if(this.children!=null){for(c in this.children){o=o.concat(this.children[c].getChildPages(false))}}else{if(this.pages!=null){o=o.concat(this.pages)}}return typeof q!="undefined"?o:o.sort(function(s,r){return s-r})};this.getAddedPages=function(q){var o=new Array();if(this.children!=null){for(c in this.children){o=o.concat(this.children[c].getAddedPages(false))}}else{if(this.addedPages!=null){o=o.concat(this.addedPages)}}return typeof q!="undefined"?o:o.sort(function(s,r){return s-r})};this.hasPage=function(o){if(this.pages!=null){for(p in this.pages){if(o==this.pages[p]){return true}}}return false};this.hasPages=function(){this.pages!=null&&this.pages.length>0};this.hasChildren=function(){return this.children!=null};this.hasChildWithLabel=function(o){o=o.toLowerCase();for(c in this.children){if(this.children[c].getLabel().toLowerCase()==o){return true}}return false};this.canRemovePage=function(o){var q=f.pagesIndex["p"+o];var s=0;var t;var r=this.getPathString()+".";for(i in q){t=q[i]+".";if(t.indexOf(r)==-1){s++}}o=null;q=null;t=null;r=null;return s>0};this.updatePathAndLevel=function(r,u){this.level=u+1;if(typeof r==="string"){r=r.split(".")}r=r.slice(0);if(r[r.length-1]!=this.id){r.push(this.id)}if(this.hasPages()){var t=r.join(".");var s=this.path.join(".");for(p in this.pages){var q=[];var o="p"+this.pages[p];if(o in f.pagesIndex){q=f.pagesIndex[o]}for(i in q){if(q[i]==s){q[i]=t}}f.pagesIndex[o]=q;q=null;o=null}s=null;t=null}this.path=r;if(this.children!=null){for(c in this.children){this.children[c].updatePathAndLevel(this.path.slice(0),this.level)}}};this.updateMaxDepth=function(w){var v=this.maxDepth>w;this.maxDepth=w;var u=this.parent;var q=1;var t;while(u!=null){t=u.getMaxDepth();if(t<w+q){u.setMaxDepth(w+q++)}else{if(t>w+q){var r=0;var o=u.getChildren();for(c in o){var s=o[c].getMaxDepth();if(s>r){r=s}}r+=1;if(r==t){break}else{if(r<t){if(r<w+q){r=w+q++}u.setMaxDepth(r)}}r=null;o=null}else{break}}u=u.getParent()}q=null;t=null;v=null;u=null};this.addPage=function(q){if(this.pages==null){this.pages=new Array()}this.pages.push(parseInt(q));var r=[];var o="p"+q;if(o in f.pagesIndex){r=f.pagesIndex[o]}r=f.uniqueArrayPush(r,this.getPathString());f.pagesIndex[o]=r;r=null;o=null;return this};this.removePage=function(q){var s=false;if(this.children!=null){for(c in this.children){if(this.children[c].removePage(q)!==false){s=true}}return s==true?this:s}if(this.pages!=null){for(i in this.pages){if(this.pages[i]==q){this.pages.splice(i,1);s=true}}}if(s){var o="p"+q;var r=f.pagesIndex[o];var t=this.getPathString();if(typeof r=="object"){for(i in r){if(r[i]==t){r.splice(i,1)}}f.pagesIndex[o]=r}o=null;r=null;t=null;return this}s=null;return false};this.removeAllPages=function(){if(this.hasPages()){var r=this.getPathString();for(p in this.pages){var o="p"+this.pages[p];var q=f.pagesIndex[o];if(typeof q=="object"){for(i in q){if(q[i]==r){q.splice(i,1)}}f.pagesIndex[o]=q}o=null;q=null}r=null;this.pages=null}if(this.children!=null){for(c in this.children){this.children[c].removeAllPages()}}};this.removeChild=function(s,o){if(typeof o=="undefined"){o=false}if(!s in this.childrenIndex){return false}var q=this.childrenIndex["c"+s];if(!o){this.children[q].removeAllPages()}for(i in this.childrenIndex){if(this.childrenIndex[i]>q){this.childrenIndex[i]--}}this.children.splice(q,1);delete this.childrenIndex["c"+s];q=null;if(this.children.length==0){this.children=null}var t=0;var r;if(this.children!=null){for(c in this.children){r=this.children[c].getMaxDepth();if(r>t){t=r}}t+=1}if(t<this.maxDepth){this.updateMaxDepth(t)}t=null;r=null;return this};this.addChild=function(s){if(this.children==null){this.children=new Array()}var r=s.getId();if(r<0){r=f.nextClusterId;s.setId(r)}s.setParent(this);s.updatePathAndLevel(this.path.slice(0),this.level);this.childrenIndex["c"+r]=this.children.length;this.children[this.children.length]=s;try{r=parseInt(r);if(!isNaN(r)&&f.nextClusterId<=(r)){f.nextClusterId=r+1}}catch(o){f.nextClusterId++}var q=s.getMaxDepth()+1;if(q>this.maxDepth){this.updateMaxDepth(q)}r=null;q=null;return s};this.toCustomString=function(){var o="id: "+this.id+"\nlevel: "+this.level+"\npages: "+this.pages+"\npath: "+this.path+"\nlabel: "+this.label+"\nsize: "+this.getSize()+"\nmaxDepth: "+this.maxDepth+"\nparent_id: "+this.getParentId()+"\n";if(this.children!=null){for(c in this.children){o+="\n    "+this.children[c].toCustomString().replace(/\n/g,"\n    ")}}return o};this.treeToJSON=function(){return this.root.toJSON()};this.toHTML=function(u){if(this.children==null&&this.pages==null&&this.label==""){return""}var t=typeof u=="undefined"||!u?"":"-last";var r="";if(this.level==0){r+='<ul id="ecTreeUl" class="ecTree">';r+='<li id="ecTreeRoot" name="0" class="root">';r+='<span class="label">'+this.getDisplayLabel()+"</span>"}else{var q=this.children!=null?"cluster-closed":"bottom-node";r+='<li name="'+this.getPathString()+'" class="'+q+t+'">';r+='<span class="label">'+this.getDisplayLabel();if(this.addedPath==true){r+='  <span class="addedPath" title="Previously edited cluster node">*</span>'}r+="</span>"}if(this.children!=null){r+="<ul>";var o=this.children.length;for(c in this.children){r+=c!=o-1?this.children[c].toHTML():this.children[c].toHTML(true)}r+="</ul>"}r+="</li>";if(this.level==0){r+="</ul>"}t=null;return r};this.init=function(q,o,s){notCopy=typeof s=="undefined"?true:!s;this.id=notCopy?""+o.id:""+f.nextClusterId++;if(q==null){this.level=0;this.path=["0"]}else{this.path=q.getPath().slice(0);this.path.push(this.id)}if(o.pages!=null){for(i in o.pages){this.addPage(o.pages[i])}}if(o.addedPages!=null){this.addedPages=o.addedPages.slice(0)}this.label=o.label;if(typeof o.addedPath!="undefined"){this.addedPath=o.addedPath}if(o.children!=null){this.children=new Array();for(c in o.children){var r=new f.node(this,o.children[c],s);this.addChild(r);r=null}}};if(typeof h!="undefined"){this.init(l,h,m)}};this.ecTreeOpException=function(m,l,h){this.message=m;this.type=typeof l!="undefined"?l:null;this.stack=typeof h!="undefined"?h:null;this.name="ecTreeOpException";this.getMessage=function(){return this.message};this.getStack=function(){return this.stack};this.toString=function(){var o=this.type==null?this.name+': "'+this.message+'"':this.name+"["+this.type+']: "'+this.message+'"';if(this.stack!=null){o+="\n\t"+h}return o}};this.getResultNodeLabel=function(l){var h=f.results.results;var m="";if(l in h){m=$.trim(h[l]["url"])}if(l in this.customResultLabels){m=this.customResultLabels[l]+m}if(m.length>this.maxPathFieldSize){m=m.substring(0,this.maxPathFieldSize-1)}return m};this.addNode=function(h,o,q){var l=this.root.getPathNode(o);if(l==null){throw new this.ecTreeOpException("Destination node path is invalid.","addNode")}if(l.hasPages()){throw new this.ecTreeOpException("Node cannot be added as destination node is a bottom node.","addNode")}if(l.getLevel()+1>this.maximumDepth){throw new this.ecTreeOpException("Node cannot be added due to maximum tree depth constraint.","addNode")}h=$.trim(h);if(h.length<1){throw new this.ecTreeOpException("The node label cannot be empty.","addNode")}if(l.hasChildWithLabel(h)){throw new this.ecTreeOpException("Node to be added already exists in destination node.","addNode")}if(typeof q=="undefined"){q=this.nextClusterId}var m=new f.node(l);m.setId(q);m.setLabel(h);return l.addChild(m)};this.copyNode=function(m,l){var u=this.root.getPathNode(l);if(u==null){throw new this.ecTreeOpException("Destination node path is invalid.","copyNode")}if(!u.hasChildren()){throw new this.ecTreeOpException("Destination node cannot be a bottom node.","copyNode")}var o=this.root.getPathNode(m);if(o==null){throw new this.ecTreeOpException("Source node path is invalid.","copyNode")}if(u.hasChildWithLabel(o.getLabel())){throw new this.ecTreeOpException("Node to be copied already exists in destination node.","copyNode")}if(o.getMaxDepth()+u.getLevel()+1>this.maximumDepth){throw new this.ecTreeOpException("Node copy invalid due to maximum tree depth constraint.","copyNode")}this.activeLabelPaths=[];var h=o.getLeafLabelPathSet();var r=o.getPath();var v=u.getLabelPath();var s=this.changePathInPathSet(h,r.length,v);for(p in s){this.activeLabelPaths.push(new this.labelPath(s[p],+1))}this.showLabelPathChanges();try{this.sendPathUpdates()}catch(q){throw new this.ecTreeOpException("Could not send path changes to the server: "+q.getMessage(),"moveNode",q)}var t=o.clone(u,true);o=null;return u.addChild(t)};this.copyResult=function(h,o,l){var m=this.root.getPathNode(h);if(m==null){throw new this.ecTreeOpException("Source node path is invalid.","copyResult")}var r=this.root.getPathNode(o);if(r==null){throw new this.ecTreeOpException("Destination node path is invalid.","copyResult")}if(r.hasChildren()){throw new this.ecTreeOpException("Destination node must be a bottom node.","copyResult")}if(r.hasPage(l)){throw new this.ecTreeOpException("Result node already exists in destination node.","copyResult")}this.activeLabelPaths=[];var s=this.root.getLabelPath(o);s.push(this.getResultNodeLabel(l));this.activeLabelPaths.push(new this.labelPath(s));this.showLabelPathChanges();try{this.sendPathUpdates()}catch(q){throw new this.ecTreeOpException("Could not send path changes to the server: "+q.getMessage(),"moveNode",q)}m=null;lpFrom=null;s=null;return r.addPage(l)};this.renameNode=function(q,l){var m=this.root.getPathNode(q);if(m==null){throw new this.ecTreeOpException("Destination node rename is invalid.","renameNode")}if(m.getParent()==null){throw new this.ecTreeOpException("Root node cannot be renamed.","renameNode")}l=$.trim(l);if(m.getLabel().toLowerCase()==l.toLowerCase()){throw new this.ecTreeOpException("The node label has not changed.","renameNode")}if(l.length<1){throw new this.ecTreeOpException("The node label cannot be empty.","renameNode")}if(m.getParent()!=null&&m.getParent().hasChildWithLabel(l)){throw new this.ecTreeOpException("Another node exists with the same label path.","renameNode")}this.activeLabelPaths=[];var h=m.getLeafLabelPathSet();for(p in h){this.activeLabelPaths.push(new this.labelPath(h[p],-1))}var r=m.getLevel();for(p in h){h[p][r]=l;this.activeLabelPaths.push(new this.labelPath(h[p],+1))}this.showLabelPathChanges();try{this.sendPathUpdates()}catch(o){throw new this.ecTreeOpException("Could not send path changes to the server: "+o.getMessage(),"moveNode",o)}m.setLabel(l);h=null;r=null;return m};this.removeNode=function(q){var m=this.root.getPathNode(q);if(m==null){throw new this.ecTreeOpException("Destination node remove is invalid.","removeNode")}var l=m.getParent();if(l==null){throw new this.ecTreeOpException("Root node cannot be removed.","removeNode")}this.activeLabelPaths=[];var h=m.getLeafLabelPathSet();for(p in h){this.activeLabelPaths.push(new this.labelPath(h[p],-1))}this.showLabelPathChanges();try{this.sendPathUpdates()}catch(o){throw new this.ecTreeOpException("Could not send path changes to the server: "+o.getMessage(),"moveNode",o)}l.removeChild(m.getId());m=null;return l};this.removeResult=function(q,l){var m=this.root.getPathNode(q);if(m==null){throw new this.ecTreeOpException("Result node is invalid.","removeResult")}this.activeLabelPaths=[];var h;var r=this.getResultNodeSubClusterPaths(l);if(r&&r.length>0){for(i in r){h=this.root.getLabelPath(r[i],l);this.activeLabelPaths.push(new this.labelPath(h,-1))}}this.showLabelPathChanges();try{this.sendPathUpdates()}catch(o){throw new this.ecTreeOpException("Could not send path changes to the server: "+o.getMessage(),"moveNode",o)}h=null;r=null;return m.removePage(l)};this.moveResult=function(m,l,o){var q=this.root.getPathNode(m);if(q==null){throw new this.ecTreeOpException("Source node path is invalid.","moveResult")}var u=this.root.getPathNode(l);if(u==null){throw new this.ecTreeOpException("Destination node path is invalid.","moveResult")}if(u.hasChildren()){throw new this.ecTreeOpException("Destination node must be a bottom node.","moveResult")}if(u.hasPage(o)){throw new this.ecTreeOpException("Destination node already contains page.","moveResult")}this.activeLabelPaths=[];var r;var t=this.getResultNodeSubClusterPaths(o);if(t&&t.length>0){for(i in t){r=this.root.getLabelPath(t[i],o);this.activeLabelPaths.push(new this.labelPath(r,-1))}}var h=this.root.getLabelPath(l);h.push(this.getResultNodeLabel(o));this.activeLabelPaths.push(new this.labelPath(h,+1));this.showLabelPathChanges();try{this.sendPathUpdates()}catch(s){throw new this.ecTreeOpException("Could not send path changes to the server: "+s.getMessage(),"moveNode",s)}r=null;h=null;try{q.removePage(o);u.addPage(o)}catch(s){throw new this.ecTreeOpException("Could not complete result move: "+s.getMessage(),"moveResult",s)}q=null;u=null};this.moveNode=function(o,m){var q=this.root.getPathNode(o);if(q==null){throw new this.ecTreeOpException("Source node path is invalid.","moveNode")}var w=q.getParent();if(w==null){throw new this.ecTreeOpException("The root node cannot be moved.","moveNode")}var x=this.root.getPathNode(m);if(x==null){throw new this.ecTreeOpException("Destination node path is invalid.","moveNode")}var u=x.getChildren();var v=q.getLabel();for(c in u){if(u[c].getLabel().toLowerCase()==v.toLowerCase()){throw new this.ecTreeOpException("Node to be moved already exists in destination node.","moveNode")}}u=null;v=null;if(q.getMaxDepth()+x.getLevel()>this.maximumDepth){throw new this.ecTreeOpException("Node move invalid due to maximum tree depth constraint.","moveNode")}this.activeLabelPaths=[];var h=q.getLeafLabelPathSet();for(p in h){this.activeLabelPaths.push(new this.labelPath(h[p],-1))}var s=q.getPath();var y=x.getLabelPath();var t=this.changePathInPathSet(h,s.length,y);for(p in t){this.activeLabelPaths.push(new this.labelPath(t[p],+1))}this.showLabelPathChanges();try{this.sendPathUpdates()}catch(r){throw new this.ecTreeOpException("Could not send path changes to the server: "+r.getMessage(),"moveNode",r)}try{var l=q.getId();q.setParent(null);x.addChild(q);w.removeChild(l,true);l=null;w=null;x=null;return q}catch(r){throw new this.ecTreeOpException("Could not complete node move: "+r.getMessage(),"moveNode",r)}};this.nodeToggle=function(l,m){if(typeof l.length==="number"){l=l.get(0)}var h=$(">ul",l);if(h.is(":visible")){l.className=l.className.replace("open","closed")}else{l.className=l.className.replace("closed","open")}h.animate({height:"toggle"},f.animationSpeed);h=null};this.subtreeToggle=function(h,l){if(!$(h).hasClass("root")){$(">ul",h).children().each(function(){f.subtreeToggle(this)});f.nodeToggle(h)}else{if($(">ul",h).children().filter(".cluster-closed, .cluster-closed-last").length>0){f.expandAll(h)}else{$(">ul",h).children().each(function(){f.collapseAll(this)})}}};this.closeLevel=function(h){$(h).siblings().filter(".cluster-open, .cluster-open-last").each(function(){var l=$(">ul",this);var m=this.className;this.className=m.replace("open","closed");l.animate({height:"toggle"},f.animationSpeed);l=null;m=null})};this.expandAll=function(h){$(".cluster-closed, .cluster-closed-last",h).each(function(){f.nodeToggle(this,f.expandAll)})};this.collapseAll=function(){$(".cluster-open, .cluster-open-last").each(function(){f.nodeToggle(this,f.collapseAll)})};this.enableToggle=function(h){$(">span",h).before('<img class="trigger" src="includes/images/tree/spacer.gif" style="float: left" border="0">');$(">.trigger",h).click(function(l){f.nodeToggle(h)})};this.getResultNodeSubClusterPaths=function(l,o){if(typeof o=="undefined"){o=this.displayedPagesNodePath}o+=".";var m=f.pagesIndex["p"+l];var q=new Array();var h;for(i in m){h=m[i]+".";if(h.indexOf(o)>-1){q.push(m[i].slice(0))}}l=null;m=null;o=null;h=null;return q};this.canDeleteResultNode=function(m){var h=$(m).attr("name");var l=this.root.getPathNode(this.displayedPagesNodePath);return l.canRemovePage(h)};this.canDeleteNode=function(o){var m=$(o).parent().attr("name");var l=this.root.getPathNode(m);var h=l.getChildPages();m=null;for(p in h){if(!l.canRemovePage(h[p])){h=null;l=null;return false}}h=null;l=null;return true};this.canAddNode=function(q,l){var o=$(q).parent().attr("name");var m=this.root.getPathNode(o);var h=l=="bottom-node"?0:1;return m.getLevel()+h<this.maximumDepth};this.canPasteNodeOrPage=function(h){if(h=="node"){return this.activeNode!=null}if(h=="page"){return this.activePage!=null}return false};this.contextMenu=function(l){f.dragEnd();var h=$(this).parent().attr("class");if(!f.editAllowed){$("#ectMenuEditDisabled > span").show();$("#ectMenuEditDisabled").css("top",l.pageY).css("left",l.pageX).show();$("*").click(function(){$("#ectMenuEditDisabled").hide()});return false}if(this.className=="label"){$(".active",b).removeClass("active");$(this).addClass("active")}else{if(this.className=="entry"){$(".active-page",a).removeClass("active-page");$(this).parent().addClass("active-page")}}$("#ecTreeMenu > span").show();if(h.indexOf("page")>=0){$("#ecTreeMenu .addNode, #ecTreeMenu .addBottomNode, #ecTreeMenu .copyNode, #ecTreeMenu .cutNode").hide();$("#ecTreeMenu .pasteNode, #ecTreeMenu .pasteResult, #ecTreeMenu .rename, #ecTreeMenu .deleteNode").hide();$("#ecTreeMenu .clearAllEdits, #ecTreeMenu .showWithoutEdits").hide();if(!f.canDeleteResultNode(this)){$("#ecTreeMenu .deleteResult").hide()}}else{if(h.indexOf("bottom-node")>=0){$("#ecTreeMenu .addNode, #ecTreeMenu .addBottomNode, #ecTreeMenu .pasteNode").hide();$("#ecTreeMenu .cutResult, #ecTreeMenu .copyResult, #ecTreeMenu .deleteResult").hide();$("#ecTreeMenu .clearAllEdits, #ecTreeMenu .showWithoutEdits").hide();if(!f.canDeleteNode(this)){$("#ecTreeMenu .deleteNode").hide()}if(!f.canPasteNodeOrPage("page")){$("#ecTreeMenu .pasteResult").hide()}if(f.activeQueryParams.clusteringAlgo==0){$("#ecTreeMenu .copyNode, #ecTreeMenu .cutNode").hide()}}else{if(h.indexOf("root")>=0){$("#ecTreeMenu .copyResult, #ecTreeMenu .pasteResult, #ecTreeMenu .deleteResult").hide();$("#ecTreeMenu .cutResult, #ecTreeMenu .cutNode, #ecTreeMenu .rename, #ecTreeMenu .deleteNode").hide();if(!f.canPasteNodeOrPage("node")){$("#ecTreeMenu .pasteNode").hide()}if(f.activeQueryParams.clusteringAlgo==0){$("#ecTreeMenu .addNode, #ecTreeMenu .copyNode").hide()}}else{$("#ecTreeMenu .copyResult, #ecTreeMenu .pasteResult, #ecTreeMenu .deleteResult").hide();$("#ecTreeMenu .cutResult, #ecTreeMenu .deleteResult").hide();$("#ecTreeMenu .clearAllEdits, #ecTreeMenu .showWithoutEdits").hide();if(!f.canDeleteNode(this)){$("#ecTreeMenu .deleteNode").hide()}if(!f.canPasteNodeOrPage("node")){$("#ecTreeMenu .pasteNode").hide()}if(!f.canAddNode(this,"bottom-node")){$("#ecTreeMenu .addNode, #ecTreeMenu .addBottomNode").hide()}else{if(!f.canAddNode(this,"node")){$("#ecTreeMenu .addNode").hide()}}}}}$("#ecTreeMenu").css("top",l.pageY).css("left",l.pageX).show();$("*").click(function(){$("#ecTreeMenu").hide()});h=null;return false};this.browseContextMenu=function(l){f.dragEnd();var h=$(this).parent().attr("class");if(this.className=="label"){$(".active",b).removeClass("active");$(this).addClass("active")}else{if(this.className=="entry"){$(".active-page",a).removeClass("active-page");$(this).parent().addClass("active-page")}}$("#ectMenuBrowseTInit > span").show();$("#ectMenuBrowseTInit").css("top",l.pageY).css("left",l.pageX).show();$("*").click(function(){$("#ectMenuBrowseTInit").hide()});h=null;return false};this.multiClick=function(l){f.dragEnd();var h=l.className;l=$(l);l.each(function(){var m=l.data("clicks")||0;m++;l.data("clicks",m);if(m==1){setTimeout(function(){var o=l.data("clicks")||0;l.data("clicks",0);if(o==1){$(".active",b).removeClass("active");if(h=="label"){l.addClass("active")}var q=l.parent().attr("name");if(q=="ecTreeRoot"){q="0"}f.showNodePages(q);q=null}else{f.subtreeToggle(l.parent().get(0))}o=null;return false},200)}m=null;return false});path=null;h=null;return false};this.clearCurrentSearch=function(){this.clearTimerMessages();this.showStats("&nbsp;");$("#"+f.resultsFooterDivElementId).html("");this.clearLabelPathChanges();this.activeNode=null;this.activePage=null;this.activePageNodePath="";this.activeRenameLabel=null;this.showResultsMessage("");if(this.taggingEnabled){this.tagItems={};this.tagSelectPaths=[];this.tagExecutionInfo={}}$("#"+this.treeDivElementId).hide()};this.executeSearch=function(s,t,v,q,u,o){this.clearCurrentSearch();if(typeof t!="string"){t=""}var h=0;if(typeof s!="undefined"){h=1}var m="";if(h==0){s=this.activeQueryParams.startAt;t=this.activeQueryParams.query;v=this.activeQueryParams.engine;q=this.activeQueryParams.itemsPerPage;u=this.activeQueryParams.lastResult;o=this.activeQueryParams.clusteringAlgo;m=this.activeQueryParams.url}else{var r=window.location;m=r.protocol+"//"+r.hostname;if(r.port!=80){m+=":"+r.port}m+="/"+r.pathname.substring(1,r.pathname.lastIndexOf("/"));r=null;this.activeQueryParams.url=m;this.activeQueryParams.clusteringAlgo=o;this.activeQueryParams.engine=v;this.activeQueryParams.query=t;this.activeQueryParams.itemsPerPage=q;this.activeQueryParams.startAt=s}this.activeQueryParams.includeEdits=h;m+="/rest/clusterJson/"+o+"/abs/"+v+"/"+escape(t)+"/"+q+"/"+s+"/"+h+".json";t=$.trim(t);if(t==""){this.showResultsMessage("Please enter search criteria.","error");return}this.showResultsMessage('Please wait... <img src="includes/images/loading.gif">');if(v=="google"&&(u>61)){var w='<span class="error">Google API does not allow retrieving more than 60 results.</span>';if(parseInt(s)-parseInt(q)>=0){w+='<br/><br/><a href="javascript:'+this.searchFunctionName+"("+(parseInt(s)-parseInt(q))+')">Back</a>'}this.showResultsMessage(w);w=null;return}if(v=="yahoo"&&(u>1001)){var w='<span class="error">Yahoo! API does not allow retrieving more than 1000 results.</span>';if(parseInt(s)-parseInt(q)>=0){w+='<br/><br/><a href="javascript:'+this.searchFunctionName+"("+(parseInt(s)-parseInt(q))+')">Back</a>'}this.showResultsMessage(w);w=null;return}setDivMessage(this.treeMessageElementId,"Please wait. Reclustering...",1000);$.ajax({url:m,type:"POST",contentType:"application/json",async:true,dataType:"json",success:function(z){if(typeof z=="object"&&z!=null&&typeof z.success!="undefined"&&z.success==true){f.presentationTimer.startTimer();var E=z.results.totalResults;var l=z.results.returnedCount;var A=z.results.firstPosition;var B=z.results.results;var C=z.results.errors;var D=z.results.clusterKey;var x=B!=null?B.length:0;var y=z.timers;if(f.activeQueryParams.includeEdits==1){f.activeQueryParams.queryId=z.query_id}if(typeof z.error!="undefined"){f.showResultsMessage(z.error,"error")}else{if(x==0){f.showResultsMessage("Your query did not produce any results.","error")}else{f.showStats("Top "+x+" of "+E+" results");f.results=z.results;f.buildClusterTree(z,h);a.html("");f.showNodePages()}}if(C!=null&&C.length>0){a.append('<span class="error"><br><br>Search produced one or more errors:<br><br>'+C.join("<br>")+"</span>")}f.showTimerMessages(y);E=null;l=null;A=null;B=null;C=null;D=null;x=null;y=null}else{var F="Your query did not produce any results.";if(typeof z.error!="undefined"){F=z.error}f.showResultsMessage(F,"error");F=null}},error:function(x,l){f.showResultsMessage("Server connection error.  Please try again.","error")}});m=null};this.sendPathUpdates=function(){var h=this.activeQueryParams.url+"/rest/clusterUpdate/"+this.activeQueryParams.queryId+"/"+this.activeQueryParams.clusteringAlgo;var l=this.jsonLabelPathSet();this.showTreeMessage('Please wait... <img src="includes/images/loading.gif">');$.ajax({url:h,type:"POST",contentType:"multipart/form-data",async:false,data:l,processData:false,dataType:"json",success:function(m){if(typeof m=="object"&&m!=null){if(typeof m.error!="undefined"){throw new f.ecTreeOpException(m.error,"sendPathUpdates")}if(typeof m.success=="undefined"||m.success!=true){throw new f.ecTreeOpException("Path update operation failed.  Please re-execute your search and try again.","sendPathUpdates")}}else{throw new f.ecTreeOpException("Unknown problem updating the paths in your cluster edit.  Please re-execute your search and try again.","sendPathUpdates")}m=null},error:function(o,m){throw new f.ecTreeOpException("Server connection error.  Please try again.","sendPathUpdates")}});h=null;l=null};this.resultDragStart=function(){f.mousePressed=false;f.dragCloneItem=null;f.dragCounter=0;if(f.dragAllowed&&f.editAllowed){f.mousePressed=true;f.dragCloneItem=$(this).parent();var l=$(this).parent();$("#ectDragContainer >ul").html("");$("#ectDragContainer").hide().css({opacity:"0.8"});var h=f.dragCloneItem.clone();$(">div",h).remove();$("#ectDragContainer >ul").html(h);$(document).bind("mousemove",{liElem:l},f.dragStart).bind("mouseup",f.dragEnd);l=null}return false};this.nodeDragStart=function(){f.mousePressed=false;f.dragCloneItem=null;f.dragCounter=0;if(f.dragAllowed&&f.editAllowed){f.mousePressed=true;f.dragCloneItem=$(this).parent();var h=$(this).parent();$("#ectDragContainer >ul").html("");$("#ectDragContainer").hide().css({opacity:"0.8"});$("#ectDragContainer >ul").html(f.dragCloneItem.clone());$(document).bind("mousemove",{liElem:h},f.dragStart).bind("mouseup",f.dragEnd);h=null}return false};this.executeDragEnd=function(s){if(f.mousePressed&&f.dragNodeSource&&f.editAllowed&&f.dragCounter>2){var r=$(f.dragCloneItem).attr("name");var m=$(f.dragCloneItem).attr("class");var q=m.indexOf("cluster")>-1;var h=m.indexOf("bottom")>-1;var l=m.indexOf("page")>-1;var t=$(this).parent().attr("name");var o=$(this).parent().attr("class");if((o.indexOf("cluster")>-1||o.indexOf("root")>-1)&&(q||h)){if(!s.ctrlKey){f.cutClusterNode(f.dragCloneItem)}else{f.copyClusterNode(f.dragCloneItem)}f.pasteClusterNode($(this).parent())}else{if(o.indexOf("bottom")>-1&&l){if(!s.ctrlKey){f.cutResultPage($(">div.entry",f.dragCloneItem))}else{f.copyResultPage($(">div.entry",f.dragCloneItem))}f.pasteResultPage($(this).parent())}}r=null;m=null;q=null;h=null;l=null;t=null;o=null}f.dragEnd()};this.dragStart=function(h){if(!f.editAllowed){return}var m=$(h.data.liElem);var l=m.attr("class");var s=l.indexOf("cluster")>-1;var o=l.indexOf("bottom")>-1;var t=l.indexOf("page")>-1;if(f.mousePressed&&f.dragAllowed){f.dragCounter+=1;if(f.dragCounter==2){if(f.dragCloneItem.attr("class").indexOf("-last")>-1){f.makeNodeLast(f.dragCloneItem.prev("li"))}}$("#ecTreeMenu").hide();if(f.dragCounter>2){if(s){$(">ul",f.dragCloneItem).hide()}if($("#ectDragContainer:not(:visible)")){$("#ectDragContainer").show();f.dragNodeSource=m}$("#ectDragContainer").css({position:"absolute",left:(h.pageX+5),top:(h.pageY+15)});if(m.is(":visible")){m.hide()}if(h.target.tagName.toLowerCase()=="span"&&h.target.className.indexOf("label")>-1){var r=h.target.parentNode;var q=$(r).offset();var u={x:(q.left-3),y:h.pageY-q.top};u.x+=19;u.y=h.pageY-u.y+5;if(r.className.indexOf("bottom")>-1){if(t){$("#ectTreePlus").css({left:u.x,top:u.y}).show()}}else{if(s||o){$("#ectTreePlus").css({left:u.x,top:u.y}).show()}}r=null;q=null;u=null}else{$("#ectTreePlus").hide()}}var m=null;var l=null;var s=null;var o=null;var t=null;return false}var m=null;var l=null;var s=null;var o=null;var t=null;return true};this.dragEnd=function(){$(document).unbind("mousemove",f.dragStart).unbind("mouseup").unbind("mousedown");$("#ectDragContainer, #ectTreePlus").hide();$("#ectDragContainer >ul").html("");if(f.dragNodeSource&&f.dragCounter>0){if(f.dragNodeSource.prev("li").length>0&&f.dragNodeSource.prev("li").attr("class").indexOf("-last")>-1){f.makeNodeNotLast(f.dragNodeSource.prev("li"))}$(f.dragNodeSource).show();if(f.dragNodeSource.attr("class").indexOf("-open")>-1){f.nodeToggle(f.dragNodeSource)}}f.dragNodeDestination=f.dragNodeSource=f.mousePressed=false;f.dragCloneItem=null;f.dragCounter=0};this.showNodePages=function(x){if(typeof x=="undefined"){x="0"}else{if(this.taggingEnabled){this.tagSelectPaths[this.tagSelectPaths.length]=x}}this.displayedPagesNodePath=x;var s;var o;var t;if(x=="0"){s=this.results.results;o=this.root;t=[this.activeQueryParams.query]}else{o=this.root.getPathNode(x);var l=o.getChildPages();l=this.getArraySet(l,true);s=new Array();for(p in l){s.push(this.results.results[l[p]])}l=null;t=o.getLabelPath(x);t[0]=this.activeQueryParams.query}var v=o.getAddedPages();v=this.getArraySet(v,true);a.html("");var q=0;var u="";var h=this.activePage==null?-1:this.activePage.attr("name");if(s.length==0){a.html(this.emptyClusterWarning)}else{for(var r=0;r<s.length;r++){var w=s[r];while(q<v.length&&v[q]<w.index){q++}if(this.activePageNodePath==x&&h==w.index){u=this.activePageOp=="copy"?" copied-page":" cut-page"}else{u=""}if(w.snippet==null||w.snippet=="null"||w.snippet==""){w.snippet="No summary available."}else{if(typeof this.highlightFunction=="function"){w.snippet=this.highlightFunction(t,w.snippet)}}if(jQuery.trim(w.title)==""){w.title="Title not availabe"}else{if(typeof this.highlightFunction=="function"){w.title=this.highlightFunction(t,w.title)}}var m='<div class="page'+u+'">'+w.id+'. <a href="'+w.clickUrl+'" class="title" target="_blank" >'+w.title+"</a>";if(v[q]==w.index){m+='  <span class="addedPath" title="Previously edited result node">*</span>'}if(this.taggingEnabled==true){m+=this.getTag(x,w.index)}m+='<div class="entry" name="'+w.index+'"><span class="snippet">'+w.snippet+'</span><br/><span class="url">'+w.url+"</span>";if(w.cacheURL!=null){m+='- <a href="'+w.cacheUrl+'" class="cached">Cached Result</a>'}m+="</div></div>";a.append(m);w=null;m=null}}s=null;t=null;$(".entry",a).bind("selectstart",function(){return false}).dblclick(function(){return false}).click(function(){$(".active-page",a).removeClass("active-page");if($(this).attr("class")=="entry"){$(this).parent().addClass("active-page")}return false});if(this.activeQueryParams.includeEdits==1){$(".entry",a).bind("contextmenu",f.contextMenu).mousedown(f.resultDragStart).mouseup(f.executeDragEnd)}else{$(".entry",a).bind("contextmenu",f.browseContextMenu).mousedown(function(y){return false}).mouseup(function(){return false});setDivMessage(f.treeMessageElementId,'Click <a id="ectReEnableEditing" href="#">here</a> to re-enable editing.');$("#ectReEnableEditing").click(function(){f.reEnableEditing()})}$(".selected",b).removeClass("selected");$("li[name='"+x+"']",b).addClass("selected");x=null;o=null;v=null;q=null};this.tag=function(l,h){this.path=l;this.resultId=h;this.indexPath=f.root.getChildIndexPath(l,h);this.resultEffort=0;this.computeResultEffort=function(){var r=this.indexPath[this.indexPath.length-1];for(var o in f.tagItems){if(this.path==f.tagItems[o].path){var q=f.tagItems[o].indexPath;var m=q[q.length-1];if(m>r){r=0;m=null;q=null;break}}}this.resultEffort=r;return r};this.toJSON=function(){return"{path: "+this.path+", indexPath: "+this.indexPath+", resultId: "+this.resultId+", resultEffort: "+this.resultEffort+"}"}};this.setTagCount=function(h){this.tagCount=h};this.getTag=function(q,h){if(!this.taggingEnabled){return""}var o=h+"";var m=false;if(o in this.tagItems){m=true}o=m?"tagged":"not_tagged";var l=' &nbsp; <img src="includes/images/'+o+'.png" onClick="ect.setTag(this, \''+q+"', '"+h+'\')" class="hovimg">';o=null;m=null;return l};this.countTags=function(){var h=0;for(key in this.tagItems){if(this.tagItems.hasOwnProperty(key)){h++}}return h};this.clearTags=function(){this.tagItems={};this.tagCount=0};this.getTagItems=function(){return this.tagItems};this.getTagSelectPaths=function(){return this.tagSelectPaths};this.getTagExecutionInfo=function(){return this.tagExecutionInfo};this.getTagVisitOnlySelectPaths=function(){var o=this.tagSelectPaths.slice(0);for(var l=0;l<o.length;l++){var m=false;for(var h in this.tagItems){if(this.tagItems[h].path==o[l]){m=true;break}}if(m){o.splice(l--,1)}}return this.getArraySet(o)};this.scoreTagVisitOnlySelectPaths=function(){var h=this.getTagVisitOnlySelectPaths();var q=0;for(var l in h){var o=h[l];var m=this.root.getPathNode(o);q+=m.getUniquePageCount();o=null;m=null;pages=null}q*=this.tagVisitOnlyPathsRate;h=null;return q};this.setTag=function(t,r,l){var o=this.countTags();var q=t.src;var h=q.indexOf("not_tagged")>-1;var m=l+"";if(h){if(this.tagCount>0&&o>=this.tagCount){alert("All necessary tags have been set.  Please unset some tags before setting the current tag.");m=null;q=null;h=null;o=null;return}this.tagItems[m]=new this.tag(r,l);q=q.replace("not_tagged","tagged");o+=1}else{delete this.tagItems[m];q=q.replace("tagged","not_tagged");o-=1}if(this.tagCount>0){if(this.tagCount-o>0||!this.editAllowed){$("#"+this.taggingElementId).html((this.tagCount-o)+" remaining tags.");$("#"+this.taggingElementId).attr("class","success")}else{$("#"+this.taggingElementId).html("0 remaining tags. Please proceed with cluster editing.");$("#"+this.taggingElementId).attr("class","error")}}this.setTagExecutionInfo();t.src=q;m=null;q=null;h=null;o=null};this.setTagExecutionInfo=function(l){if(typeof l=="undefined"){l=false}var o=this.countTags();if(!l&&(o==0||o%5!=0)){return}var m={};var s=0;var q=0;var h=0;m.tags=this.getTagItems();m.userSelectedPathsList=this.getTagSelectPaths();m.pathScanningUserEffort=this.getPathScanningUserEffort();m.visitOnlyPathSet=this.getTagVisitOnlySelectPaths();m.visitOnlyPathsScore=this.scoreTagVisitOnlySelectPaths();s=this.getUserEffort();q=this.getBaseEffort();h=this.getBaseRelevantEffort();var r={userEffort:s,baseEffort:q,baseRelevantEffort:h,tags:m};this.tagExecutionInfo[o+""]=this.clone(r);r=null;m=null;s=null;q=null;h=null;o=null};this.getBaseRelevantEffort=function(){if(this.tagCount==0){return 0}var l=this.results.results;var o=0;var m=0;for(var h=0;h<l.length;h++){if(l[h].relevant>0){m+=1;o=l[h].index+1}if(m==this.tagCount){break}}l=null;return o};this.getPathScanningUserEffort=function(){var t=this.getArraySet(this.tagSelectPaths.slice(0));var m={};for(var q in t){var s=t[q];var l=this.root.getChildIndexPath(s);var o=l.length>1?l.slice(0,l.length-1).join("."):"r";if(o in m){var r=m[o];if(r[r.length-1]<l[l.length-1]){m[o]=l.slice(0)}r=null}else{m[o]=l.slice(0)}s=null;l=null;o=null}var h=0;for(var o in m){var r=m[o];for(var q=0;q<r.length;q++){h+=0.25*r[q]}r=null}return h};this.getUserEffort=function(){if(this.tagCount==0){return 0}var h=0;for(var l in this.tagItems){h+=this.tagItems[l].computeResultEffort()}h+=this.scoreTagVisitOnlySelectPaths();h+=this.getPathScanningUserEffort();return h};this.getBaseEffort=function(){if(this.tagCount==0){return 0}var m=[];for(var h in this.tagItems){m[m.length]=parseInt(this.tagItems[h].resultId)}m.sort(function(q,o){return o-q});var l=m[0]+1;return l};this.addNodeEvents=function(m,o){if(typeof o=="undefined"){o=false}$("span",m).bind("selectstart",function(){return false}).dblclick(function(){return f.multiClick(this)}).click(function(){return f.multiClick(this)}).bind("contextmenu",f.contextMenu).mousedown(f.nodeDragStart).mouseup(f.executeDragEnd);if(o){var l=m.get(0).className;var h=$(">ul",m);if(h.size()>0){if(l&&l.indexOf("closed")>-1){h.hide()}f.enableToggle(m)}l=null;h=null}$("li",m).each(function(r){var s=this.className;var q=$(">ul",this);if(q.size()>0){if(s&&s.indexOf("closed")>-1){q.hide()}f.enableToggle(this)}s=null;q=null})};this.addTInitNodeEvents=function(m,o){if(typeof o=="undefined"){o=false}$("span",m).bind("selectstart",function(){return false}).dblclick(function(){return f.multiClick(this)}).click(function(){return f.multiClick(this)}).bind("contextmenu",f.browseContextMenu).mousedown(function(q){return false}).mouseup(function(){return false});if(o){var l=m.get(0).className;var h=$(">ul",m);if(h.size()>0){if(l&&l.indexOf("closed")>-1){h.hide()}f.enableToggle(m)}l=null;h=null}$("li",m).each(function(r){var s=this.className;var q=$(">ul",this);if(q.size()>0){if(s&&s.indexOf("closed")>-1){q.hide()}f.enableToggle(this)}s=null;q=null})};this.buildClusterTree=function(l,h){this.customResultLabels=l.cluster.customResultLabels;this.pagesIndex={};this.root=new f.node(null,l.cluster);$("#"+this.treeDivElementId).html(this.root.toHTML()).show();b=$("#ecTreeUl").get(0);e=$("#ecTreeRoot").get(0);if(h==1){this.addNodeEvents(e)}else{this.addTInitNodeEvents(e)}if(this.editAllowed){this.showTreeMessage("Right-click on nodes to access tree operations.")}};this.clearAllEdits=function(){var h=this.activeQueryParams.url+"/rest/deleteClusterEdits/"+this.activeQueryParams.queryId+"/"+this.activeQueryParams.clusteringAlgo;this.showTreeMessage('Please wait... <img src="includes/images/loading.gif">');try{$.ajax({url:h,type:"POST",async:false,dataType:"json",success:function(o){if(typeof o=="object"&&o!=null){if(typeof o.error!="undefined"){throw new f.ecTreeOpException(o.error,"clearAllEdits")}if(typeof o.success=="undefined"||o.success!=true){throw new f.ecTreeOpException("Clear edits operation failed.  Please re-execute your search and try again.","sendPathUpdates")}}else{throw new f.ecTreeOpException("Unknown problem clearing edits in your cluster edit.  Please re-execute your search and try again.","sendPathUpdates")}o=null},error:function(q,o){throw new f.ecTreeOpException("Server connection error.  Please try again.","sendPathUpdates")}})}catch(m){var l=m instanceof this.ecTreeOpException?m.getMessage():m;this.showTreeMessage(l,"error");l=null;return}h=null;this.executeSearch(this.activeQueryParams.startAt,this.activeQueryParams.query,this.activeQueryParams.engine,this.activeQueryParams.itemsPerPage,this.activeQueryParams.lastResult,this.activeQueryParams.clusteringAlgo)};this.reEnableEditing=function(){this.executeSearch(this.activeQueryParams.startAt,this.activeQueryParams.query,this.activeQueryParams.engine,this.activeQueryParams.itemsPerPage,this.activeQueryParams.lastResult,this.activeQueryParams.clusteringAlgo)};this.getLastChild=function(l){var m=l.children();if(m.size()==0){return false}var h=m.get(m.size()-1);m=null;return $(h)};this.isLastNode=function(l){if(l.attr("name")=="0"){return true}var h=this.getLastChild(l.parent());return h.attr("name")==l.attr("name")};this.convertToBottomNode=function(h){$(">ul",h).remove();$("img",h).remove();h.removeClass("cluster-open").removeClass("cluster-closed").addClass("bottom-node")};this.convertToInnerNode=function(h){h.removeClass("bottom-node").addClass("cluster-open");this.setTrigger(h)};this.makeNodeNotLast=function(o){if(typeof o!="object"||o.length==0){return}var h=o.attr("class");var r=o.hasClass("active");var m=o.hasClass("selected");var l=o.hasClass("copied");var q=o.hasClass("cut");o.attr("class",h.replace("-last",""));if(r){o.addClass("active")}if(m){o.addClass("selected")}if(l){o.addClass("copied")}if(q){o.addClass("cut")}h=null};this.makeNodeLast=function(m){if(typeof m!="object"||m.length==0){return}var r=m.attr("class").split(/\s+/);var q=m.hasClass("active");var l=m.hasClass("selected");var h=m.hasClass("copied");var o=m.hasClass("cut");$.each(r,function(s,t){if(r[s].indexOf("-last")==-1&&(r[s].indexOf("cluster")>-1||r[s].indexOf("bottom")>-1)){r[s]=t+"-last"}});m.attr("class",r.join(" "));if(q){m.addClass("active")}if(l){m.addClass("selected")}if(h){m.addClass("copied")}if(o){m.addClass("cut")}r=null};this.copyClusterNode=function(h){this.clearLabelPathChanges();if(typeof h=="undefined"){h=$("span.active",b).parent()}this.activeNode=h;this.activeNodeOp="copy";h=null;$(".copied",b).removeClass("copied");$(".cut",b).removeClass("cut");this.activeNode.addClass("copied")};this.cutClusterNode=function(h){this.clearLabelPathChanges();if(typeof h=="undefined"){h=$("span.active",b).parent()}this.activeNode=h;this.activeNodeOp="cut";h=null;$(".copied",b).removeClass("copied");$(".cut",b).removeClass("cut");this.activeNode.addClass("cut")};this.pasteClusterNode=function(h){if(typeof h=="undefined"){h=$("span.active",b).parent()}var l=h.attr("name");var q=this.activeNode;var m=q.attr("name");try{var u,w;if(this.activeNodeOp=="copy"){u=this.copyNode(m,l)}else{if(this.activeNodeOp=="cut"){u=this.moveNode(m,l)}}var v=$(">ul",h);this.makeNodeNotLast(this.getLastChild(v));v.append(u.toHTML(true));if(this.activeNodeOp=="cut"){w=q.attr("class");if(w.indexOf("-last")>-1){this.makeNodeLast(q.prev("li"))}q.remove()}var r=u.getPathString();var y=$("li[name='"+r+"']",v);this.addNodeEvents(y,true);w=h.attr("class");if(w.indexOf("-closed")>-1){this.nodeToggle(h)}this.updatePathNodeLabels(l);if(this.activeNodeOp=="cut"){var t=m.substring(0,m.lastIndexOf("."));this.updatePathNodeLabels(t);if(m==this.displayedPagesNodePath){y.addClass("selected");this.displayedPagesNodePath=r}else{if(m.indexOf(this.displayedPagesNodePath)>-1){this.showNodePages(this.displayedPagesNodePath)}}if(m.lastIndexOf(".")>2){var o=this.root.getPathNode(t);if(!o.hasChildren()){this.convertToBottomNode($("li[name='"+t+"']",b));if(this.displayedPagesNodePath==t){a.html(this.emptyClusterWarning)}}o=null}this.showTreeMessage("Label node moved successfully!","success");this.activeNode=null;this.activeNodeOp="";t=null;$(".cut",b).removeClass("cut")}else{this.showTreeMessage("Label node copied successfully!","success")}if(l.indexOf(this.displayedPagesNodePath)>-1){this.showNodePages(this.displayedPagesNodePath)}u=null;w=null;v=null;r=null;y=null}catch(s){var x=s instanceof this.ecTreeOpException?s.getMessage():s;this.showTreeMessage(x,"error");x=null}h=null;l=null;q=null;m=null};this.renameClusterNode=function(){this.clearLabelPathChanges();var h=$("span.active",b).parent();var l=h.attr("name");if(this.activeRenameLabel!=null){$("#ecTreeInput").prev("span").html(this.activeRenameLabel);$("#ecTreeInput").remove();this.activeRenameLabel=null}var m=this.root.getPathNode(l);this.activeRenameLabel=$(">span",h).html();$(">span",h).html("").after('<input type="text" id="ecTreeInput" value="'+m.getLabel()+'" maxlength="'+this.maximumLabelLength+'">');if(m.getLevel()>1){$("#ecTreeInput").width($("#ecTreeInput").width()-(24*(m.getLevel()-1)))}$("#ecTreeInput").focus().bind("keypress",function(o){if(o.keyCode==13){var q=$("#ecTreeInput").attr("value");var r=$("#ecTreeInput").parent().attr("name");f.renameClusterNodeCallback(r,q);q=null;r=null;f.activeRenameLabel=null;f.dragAllowed=f.dragSetting}else{if(o.keyCode==27){$("#ecTreeInput").prev("span").html(f.activeRenameLabel);$("#ecTreeInput").remove();f.activeRenameLabel=null;f.dragAllowed=f.dragSetting}}});$("#ecTreeInput").blur(function(){var o=$("#ecTreeInput").attr("value");var q=$("#ecTreeInput").parent().attr("name");f.renameClusterNodeCallback(q,o);o=null;q=null;f.activeRenameLabel=null;f.dragAllowed=f.dragSetting});this.dragSetting=this.dragAllowed;this.dragAllowed=false;h=null;l=null;m=null};this.renameClusterNodeCallback=function(l,h){try{var o=this.renameNode(l,h);h=o.getDisplayLabel();o=null;$("#ecTreeInput").prev("span").html(h);$("#ecTreeInput").remove();this.showTreeMessage("Label renamed successfully!","success")}catch(q){try{h=this.root.getPathNode(l).getLabel()}catch(q){}var m=q instanceof this.ecTreeOpException?q.getMessage():q;this.showTreeMessage(m,"error");m=null;$("#ecTreeInput").prev("span").html(h);$("#ecTreeInput").remove()}};this.addClusterNode=function(l){this.clearLabelPathChanges();var o=$("span.active",b).parent();var q=o.attr("name");if(this.activeRenameLabel!=null){$("#ecTreeInput").prev("span").html(this.activeRenameLabel);$("#ecTreeInput").remove();this.activeRenameLabel=null}var m=this.root.getPathNode(q);this.activeRenameLabel=null;cls=o.attr("class");if(cls.indexOf("-closed")>-1){this.nodeToggle(o)}if(l){$(">ul",o).append('<li class="bottom-node-last" name="addNode"><span class="label"></span><input type="text" id="ecTreeInput" value="" maxlength="'+this.maximumLabelLength+'"></li>')}else{$(">ul",o).append('<li class="cluster-open-last" name="addNode"><span class="label"></span><input type="text" id="ecTreeInput" value="" maxlength="'+this.maximumLabelLength+'"><ul style="display: block;"></ul></li>')}var h=$("li[name='addNode']",o);this.makeNodeNotLast(h.prev("li"));if(m.getLevel()>0){$("#ecTreeInput").width($("#ecTreeInput").width()-(24*(m.getLevel())))}$("#ecTreeInput").focus().bind("keypress",function(s){if(s.keyCode==13){var t=$("#ecTreeInput").attr("value");var u=$("#ecTreeInput").parent().parent().parent().attr("name");f.addClusterNodeCallback(u,t);t=null;u=null;f.activeRenameLabel=null;f.dragAllowed=f.dragSetting}else{if(s.keyCode==27){var r=$("#ecTreeInput").parent();f.makeNodeLast(r.prev("li"));r.remove();r=null;f.activeRenameLabel=null;f.dragAllowed=f.dragSetting}}});$("#ecTreeInput").blur(function(){var r=$("#ecTreeInput").attr("value");var s=$("#ecTreeInput").parent().parent().parent().attr("name");f.addClusterNodeCallback(s,r);r=null;s=null;f.activeRenameLabel=null;f.dragAllowed=f.dragSetting});this.dragSetting=this.dragAllowed;this.dragAllowed=false;o=null;q=null;m=null};this.addClusterNodeCallback=function(m,o){try{var s=this.addNode(o,m);o=s.getDisplayLabel();$("#ecTreeInput").prev("span").html(o);var r=$("#ecTreeInput").parent();var l=r.get(0).className;if(l.indexOf("cluster")>-1){s.setChildren(new Array())}r.attr("name",s.getPathString());$("#ecTreeInput").remove();this.addNodeEvents(r,true);s=null;r=null;this.showTreeMessage("Label added successfully!","success")}catch(t){var q=t instanceof this.ecTreeOpException?t.getMessage():t;this.showTreeMessage(q,"error");q=null;var h=$("#ecTreeInput").parent();f.makeNodeLast(h.prev("li"));h.remove();h=null}};this.deleteClusterNode=function(){var t=$("span.active",b).parent();var m=t.attr("name");try{var l=this.removeNode(m);var o=t.attr("class");if(o.indexOf("-last")>-1){this.makeNodeLast(t.prev("li"))}t.remove();var h=m.substring(0,m.lastIndexOf("."));this.updatePathNodeLabels(h);if(m.lastIndexOf(".")>2){var r=this.root.getPathNode(h);if(!r.hasChildren()){this.convertToBottomNode($("li[name='"+h+"']",b))}r=null}if(m==this.displayedPagesNodePath){this.showNodePages(h)}else{if(m.indexOf(this.displayedPagesNodePath)>-1){this.showNodePages(this.displayedPagesNodePath)}}this.showTreeMessage("Label node deleted successfully!","success");l=null;o=null;h=null}catch(s){var q=s instanceof this.ecTreeOpException?s.getMessage():s;this.showTreeMessage(q,"error");q=null}t=null;m=null;this.activeNode=null;this.activeNodeOp="";$(".copied",b).removeClass("copied");$(".cut",b).removeClass("cut")};this.copyResultPage=function(h){this.clearLabelPathChanges();if(typeof h=="undefined"){h=$("div.active-page>div",a)}this.activePage=h;this.activePageNodePath=this.displayedPagesNodePath;this.activePageOp="copy";h=null;$(".copied-page",a).removeClass("copied-page");$(".cut-page",a).removeClass("cut-page");this.activePage.parent().addClass("copied-page")};this.cutResultPage=function(l){this.clearLabelPathChanges();var h=this.displayedPagesNodePath;if(typeof l=="undefined"){l=$("div.active-page>div",a)}this.activePage=l;this.activePageNodePath=this.displayedPagesNodePath;this.activePageOp="cut";l=null;$(".copied-page",a).removeClass("copied-page");$(".cut-page",a).removeClass("cut-page");this.activePage.parent().addClass("cut-page");h=null;deleteFromNode=null};this.pasteResultPage=function(s){if(typeof s=="undefined"){s=$("span.active",b).parent()}var r=s.attr("name");var o=this.activePage.attr("name");var h=this.activePageNodePath;try{if(this.activePageOp=="copy"){this.copyResult(h,r,o)}else{if(this.activePageOp=="cut"){this.moveResult(h,r,o)}}var m=this.root.getPathNode(r);this.updatePathNodeLabels(r);if(this.activePageOp=="cut"){var l=this.root.getPathNode(h);this.updateChildPathNodeLabels(h);this.activePage.parent().remove();this.showTreeMessage("Result node moved successfully!","success");if($(".entry",a).length==0){a.html(this.emptyClusterWarning)}this.activePage=null;this.activePageOp="";l=null}else{this.showTreeMessage("Result node copied successfully!","success")}if(r.indexOf(this.displayedPagesNodePath)>-1){this.showNodePages(this.displayedPagesNodePath)}m=null}catch(t){var q=t instanceof this.ecTreeOpException?t.getMessage():t;this.showTreeMessage(q,"error");q=null}s=null;r=null;o=null;h=null};this.deleteResultPage=function(){var m=$("div.active-page>div",a);var l=m.attr("name");var h=this.displayedPagesNodePath;try{this.removeResult(h,l);var o=this.root.getPathNode(h);this.updateChildPathNodeLabels(h);m.parent().remove();this.showTreeMessage("Result node removed successfully!","success");if($(".entry",a).length==0){a.html(this.emptyClusterWarning)}o=null}catch(r){var q=r instanceof this.ecTreeOpException?r.getMessage():r;this.showTreeMessage(q,"error");q=null}this.activePage=null;this.activePageOp="";m=null;l=null;h=null;index=null;deleteFromNode=null};this.updatePathNodeLabels=function(q){var l=q.split(".");var o=b;var m=this.root;var r=m.getPathString();o=$("li[name='"+r+"']",o);o.children().filter("span").html(m.getDisplayLabel());for(var h=1;h<l.length;h++){m=m.getChild(l[h]);if(m==null){break}r=m.getPathString();o=$("li[name='"+r+"']",o);if(o.length==0){break}o.children().filter("span").html(m.getDisplayLabel())}r=null;l=null;o=null;return m};this.updateChildPathNodeLabels=function(o,m,l){if(typeof m=="undefined"){m=this.updatePathNodeLabels(o)}var q;if(m!=null){q=m.getPathString();l=$("li[name='"+q+"']",l);if(l.length==0){return false}l.children().filter("span").html(m.getDisplayLabel());if(m.hasChildren()){var h=m.getChildren();for(c in h){this.updateChildPathNodeLabels(null,h[c],l)}h=null}}return m};if($("#ecTreeMenu").length==0){$("body").append(this.contextMenuDiv);$("body").append(this.disabledEditContextMenuDiv);$("body").append(this.browseTInitContextMenuDiv);$("#ecTreeMenu .addNode").click(function(){f.addClusterNode(false)});$("#ecTreeMenu .addBottomNode").click(function(){f.addClusterNode(true)});$("#ecTreeMenu .copyNode").click(function(){f.copyClusterNode()});$("#ecTreeMenu .copyResult").click(function(){f.copyResultPage()});$("#ecTreeMenu .cutNode").click(function(){f.cutClusterNode()});$("#ecTreeMenu .cutResult").click(function(){f.cutResultPage()});$("#ecTreeMenu .pasteNode").click(function(){f.pasteClusterNode()});$("#ecTreeMenu .pasteResult").click(function(){f.pasteResultPage()});$("#ecTreeMenu .rename").click(function(){f.renameClusterNode()});$("#ecTreeMenu .deleteNode").click(function(){f.deleteClusterNode()});$("#ecTreeMenu .deleteResult").click(function(){f.deleteResultPage()});$("#ecTreeMenu .clearAllEdits").click(function(){f.clearAllEdits()});$("#ecTreeMenu .showWithoutEdits").click(function(){f.executeSearch()})}if(this.dragAllowed==true){if($("#ectDragContainer").length==0){$("body").append('<div id="ectDragContainer"><ul class="ecTree"></ul></div>')}$("#ectDragContainer").hide();if($("#ectTreePlus").length==0){$("<img>").attr({id:"ectTreePlus",src:"includes/images/tree/plus.gif"}).css({width:"7px",display:"block",position:"absolute",left:"5px",top:"5px",display:"none"}).appendTo("body")}$("#ectTreePlus").hide()}return this}function setDivMessage(e,f,a,b){$("#"+e).removeClass("error");$("#"+e).removeClass("success");$("#"+e).html(f);var g=new Date();g=g.getTime();ectMessageTimeout[e]=g;if(typeof a=="number"){setTimeout("clearDivMessage('"+e+"','"+g+"')",a)}if(typeof b=="string"){$("#"+e).addClass(b)}g=null}function clearDivMessage(a,b){if(ectMessageTimeout[a]==b){$("#"+a).html("&nbsp;");$("#"+a).removeClass("error");$("#"+a).removeClass("success")}}var ectMessageTimeout={};$(window).unload(function(){ectMessageTimeout=null});